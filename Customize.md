# Customization For Your Application

The example applications are very simple, and while it is entirely possible for you
to extend them, it seems more likely that you'd want to create your own from scratch
and consult the examples for information on how to do things like use databases or
KMS or share secrets or whatever.

## General Thoughts

* You should remove the `dotnet-example` and `rails-example` directories, so you
  do not have extra code in your project.  You will probably want to create your
  app in a subdirectory there instead.
* Google App Engine supports a 
  [few frameworks](https://cloud.google.com/appengine/docs/flexible/).
  Be sure you use a supported version of the framework.
* You will need to customize the `.circleci/config.yml` file to remove the
  example apps and add yours in.  **This file is the core of automation in this project.**
  The example deployment pipelines in there do a lot of work, and you should copy from
  them liberally to be sure that you are still following the DevSecOps best
  practices that they implement, such as testing, scanning, etc.

  If you are not using a framework that has
  an example app, you may have to write your own deployment pipeline from
  scratch.  If you need to add more steps beyond "deploy, test, scan, promote",
  then feel free to do so.
* We are trying to keep the secrets mostly managed by terraform so that they
  are relatively easy to rotate and are not kept by operators.  These secrets
  and other config are passed into the applications via environment variables
  that are generated by the circleci pipeline and placed into the `app.yaml`
  file that is used to deploy the app.  The circleci pipeline uses
  the branch that it's building to find secrets and other environment-specific
  info in the terraform output.
* Everything in the database storage and Cloud Storage buckets are all encrypted at
  rest.  You can also use KMS to encrypt things, so if your app requires more
  encryption of data, make sure you read up on that:  https://cloud.google.com/kms/
* The example apps all share the same usernames/passwords for the databases they access.
  This makes the config simpler, but if you happen to have multiple apps running in
  your environment, you probably will want to generate unique accounts for each so that
  they can't read each other's data.  You can do that in the `terraform/google_sql.tf`
  file.

## Domains/SSL

The procedure for mapping a custom domain onto your application can be found here:
https://cloud.google.com/appengine/docs/standard/python/mapping-custom-domains

This is so you can access your app through something like `https://myapp.gsa.gov/`
instead of `https://<projectappnamestring>.appspot.com/`.  Once this is enabled,
GCP should issue a proper SSL cert too.

## Authentication

You will probably need to keep authentication in front of your application
until you have your ATO.  The .NET core example app has
basic auth enabled, and the rails example app has an OAuth2 proxy in front of it.
Another option is to implement OAuth2 support directly in your application, though
we do not have an example of that here.

Here are some identity providers you might want to integrate with:
  * [login.gov](https://login.gov/), which has excellent
    [developer documentation](https://developers.login.gov/).
  * [GSA SecureAuth](https://secureauth.gsa.gov/), which seems to have
    no public documentation, but according to the IT Servicedesk, you can
    submit a Single Sign-On Integration Request:
    ```
    1. Go to servicedesk.gsa.gov
	  2. Click on "Order Something"
	  3. Click on the following options respectively: General Requests > Single Sign-On Integration Request
	  (Please refer to the Lightweight Security Authorization Process Form for information on FIPS 199.)

	  *All fields marked with a red asterisk must be populated*

	  **Your supervisor will receive an email after the request is submitted. That email will give them the option to either approve or deny the request. Failure to approve/deny the request will result in the ticket being cancelled**
    ```
  * [cloud.gov UAA](https://cloud.gov/docs/apps/leveraging-authentication/),
    although this probably is not useful unless you have a cloud.gov
    account, it has some good documentation on the subject.

One thing that you should be aware of if you are using the OAuth2 proxy is
that the application launched behind the proxy needs to ensure that traffic
not originating from the proxy is rejected.  This can be done by checking
the HMAC in the `GAP-Signature` header using the key found in the `SIGNATURE_KEY`
environment variable in the application, and if it does not verify, reject
the request.  This is usually simpler to do than implementing the full OAuth2
control flow.  An example of this can be found in the rails-example 
[application_controller.rb](https://github.com/18F/gcp-appengine-template/blob/master/rails-example/app/controllers/application_controller.rb).
More info on how the proxy is configured to do this, and HMAC in general can be found here:
https://github.com/pusher/oauth2_proxy#request-signatures

## Automated scanning

Circleci will automatically scan the applications upon deploy with 
[OWASP ZAP](https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project).  One thing to note
is that if your app uses authentication (basic auth or SSO proxy, etc), then you
will need to probably add an authentication header to your app that allows ZAP to
securely scan without doing a login.  You can see how to do this in the `owaspzap-rails` job
in the circleci [config.yml](https://github.com/18F/gcp-appengine-template/blob/master/.circleci/config.yml),
and how you might check this header in the rails-example 
[application_controller.rb](https://github.com/18F/gcp-appengine-template/blob/master/rails-example/app/controllers/application_controller.rb)

You should also probably scan while doing local development, since that is faster to do
than waiting for a deploy.  You can do this by:
  * `docker pull owasp/zap2docker-weekly` to get the OWASP ZAP scanner ready for you to use.
  * Start up your app for local development.  In the case of the rails-example, that would be
    `rails server`.
  * Figure out your computer's local IP address.  While you might access the app over
    http://localhost:3000/, docker cannot, because it has it's own localhost IP.
    For example, your system might have been issued `10.0.1.50` as your local IP on
    your network.
  * `docker run -t owasp/zap2docker-weekly zap-full-scan.py -t http://YOURIPHERE:3000/`, where
    `YOURIPHERE` is your IP address as we discovered in your last step.
  * The scanner should run and issue a report that you can use to understand what sort of
    things might have security problems that require fixing.
  * Be aware that the scanner will try submitting forms many times, so if you have a form
    that sends email or adds entries to a blog or something, that form will be triggered by
    the scanner.  You may need to adjust the scanner to skip certain urls.
    https://github.com/zaproxy/zaproxy/wiki/FAQpreventSpam

More information on how to configure and use the OWASP ZAP scanner in this way
can be found on their wiki:  https://github.com/zaproxy/zaproxy/wiki/ZAP-Full-Scan  

You can also use the proxy on your computer in GUI mode, which is much more like a traditional
app, and thus less tricky to customize than the docker version, which is better for automated 
scans.  More info on that can be found in the 
"Getting Started Guide" on https://github.com/zaproxy/zaproxy/wiki/Downloads.

## Offsite Logging
Logs are collected by [GCP Stackdriver](https://console.cloud.google.com/logs/viewer).
They are exported to a [GCP Cloud Storage](https://console.cloud.google.com/storage/browser)
bucket, which is then periodically synced with an s3 bucket maintained by the GSA
IT Security people, where it is slurped into their logging system.

If you want to customize what logs get exported, then you will want to edit the 
`"google_logging_project_sink" "securitystuff"` resource
in `terraform/google_storage.tf`.  Right now, it just sends the logs that the 
[GSA Logging and Audit Compliance Guidance document](https://docs.google.com/document/d/1MkaYZr6633vobLkYpNZcqPfQTvCUgR4XNahcmeryXgg/edit)
requires.
